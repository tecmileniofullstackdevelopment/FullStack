<!-- Los cambios que hicimos aquí (Juan, Adrián y Rafa) fue para que al poner el email en el campo, se revise la base de datos -->
<!-- Si el correo existe, aparece otro campo para poner la nueva contraseña y se guarda en la bd -->
<!-- Si no existe, lanza mensaje de error -->

<!-- Añadido el botón para cambiar el tema en esta página-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Smooch+Sans:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="logstyle.css">
    <script src="scriptLightDark.js"></script>
    <title>Forgot Password</title>
</head>

<body class = "body_ForgotPass">
    <img id="imgLightDark" src="imgLightDark.png"></img>
    <div id="container">
        <h2 id="title">Enter your Email to reset your password</h2>
        <div class="user">
            <input type="email" placeholder="Email ID" id="userfield" />
        </div>
        <button id="verifyBtn" onclick="resetEmail()">OK</button>
    </div>

    <script>
        let email = "";
        async function resetEmail() {
            const emailInput = document.getElementById("userfield");
            const button = document.getElementById("verifyBtn");
            const container = document.querySelector(".container");
            email = emailInput.value.trim();

            if (!email) {
                alert("Please enter your email.");
                return;
            }

            // Verificar si el email existe en la base de datos
            const response = await fetch("/auth/check-email", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
            });

            const data = await response.json();

            if (data.exists) {
                // Cambiar el contenido del formulario para pedir la nueva contraseña
                container.innerHTML = `
                    <h2 id="title">Enter Your New Password</h2>
                    <div class="user">
                    <input type="password" placeholder="New Password" id="newPassword" />
                    </div>
                    <button id="resetBtn" onclick="resetPass()">Reset Password</button>
                `;
            } else {
                alert("Email not found.");
            }
        }

        async function resetPass() {
            // Evento para actualizar la contraseña
            const newPassword = document.getElementById("newPassword").value.trim();

            if (!newPassword) {
                alert("Please enter a new password.");
                return;
            }

            // Enviar nueva contraseña al backend
            const response = await fetch("/auth/reset-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, newPassword }),
            });

            const data = await response.json();
            if (data.success) {
                alert("Password updated successfully!");
                window.location.href = "index.html";
            } else {
                alert("Error updating password.");
            }
        }
    </script>
</body>

</html>

<style>
    button {
        background-color: rgb(255, 255, 255);
        color: black;
        border-style: none;
        border-radius: 20px;
        height: 40px;
        width: 235px;
        cursor: pointer;
        transition: opacity 0.3s;
        font-family: "Smooch Sans", serif;
        font-size: larger;
        margin-top: 15px;
    }

    button:hover {
        opacity: 0.8;
    }

    button:active {
        opacity: 0.4;
    }

    .container {
        position: fixed;
        left: 50%;
        bottom: 50%;
        transform: translate(-50%, 50%);
        font-family: "Smooch Sans", serif;
        text-align: center;
        border-style: solid;
        border-radius: 15px;
        border-width: 2px;
        border-color: rgb(255, 255, 255);
        height: 35%;
        width: 23%;
        backdrop-filter: blur(3px);
    }

    #title {
        color: white;
    }

    input {
        border-radius: 20px;
        border-width: 2px;
        border-color: white;
        border-style: solid;
        height: 35px;
        width: 220px;
        font-family: "Smooch Sans", serif;
        font-size: larger;
        background: transparent;
        color: white;
        padding-left: 15px;
        margin-top: 15px;
    }

    html {
        background-image: url('naranjafondo.jpg');
        background-size: 1100px;
        background-position: top;
    }
</style>
