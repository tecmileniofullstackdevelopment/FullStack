<!-- Los cambios que hicimos aqu칤 (Juan, Adri치n y Rafa) fue para que al poner el email en el campo, se revise la base de datos -->
<!-- Si el correo existe, aparece otro campo para poner la nueva contrase침a y se guarda en la bd -->
<!-- Si no existe, lanza mensaje de error -->

<!-- A침adido el bot칩n para cambiar el tema en esta p치gina-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" href="promocion.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Smooch+Sans:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="logstyle.css">
    <script src="scriptLightDark.js"></script>
    <title>Forgot Password</title>
</head>

<body class="body_ForgotPass">
    <img id="imgLightDark" src="imgLightDark.png" />
    <div class="container">
        <button id="backBtn" onclick="backToLogin()">游댗</button>
        <h2 id="title" display:inline>Enter Your Email</h2>
        <div class="user">
            <input type="email" placeholder="Email ID" id="userfield" />
        </div>
        <button id="verifyBtn" onclick="resetEmail()">OK</button>
        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        let email = "";

        function backToLogin() {
            window.location.href = "index.html";
        }

        async function resetEmail() {
            const container = document.querySelector(".container");
            const errorMessage = document.getElementById("errorMessage");

            // Validaci칩n adicional
            if (!container) {
                console.error("Container no encontrado");
                return;
            }

            email = document.getElementById("userfield").value.trim();
            if (!email) {
                errorMessage.textContent = "Please enter your email.";
                errorMessage.style.display = "block";
                return;
            }

            // Verificar el email en el backend
            const response = await fetch("/auth/check-email", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
            });

            const data = await response.json();
            if (data.exists) {
                // Actualizar el contenido del container
                container.innerHTML = `
                    <button id="backBtn" onclick="backToLogin()">游댗</button>
                    <h2 id="title">Enter Your New Password</h2>
                    <div class="user">
                        <input type="password" placeholder="New Password" id="newPassword" />
                    </div>
                    <button id="resetBtn" onclick="resetPass()">Reset Password</button>
                    <div id="errorMessage" class="error-message"></div>
                `;
            } else {
                errorMessage.textContent = "Email not found.";
                errorMessage.style.display = "block";
            }
        }

        async function resetPass() {
            const newPassword = document.getElementById("newPassword").value.trim();

            if (!newPassword) {
                errorMessage.textContent = "Please enter a new password";
                errorMessage.style.display = "block";
                return;
            }

            // Enviar nueva contrase침a al backend
            const response = await fetch("/auth/reset-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, newPassword }),
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = "index.html";
            } else {
                errorMessage.textContent = "Error updating password";
                errorMessage.style.display = "block";
            }
        }
    </script>
</body>

</html>

<style>
    button {
        background-color: light-dark(black, white);
        color: light-dark(white, black);
        border-style: none;
        border-radius: 20px;
        height: 40px;
        width: 235px;
        cursor: pointer;
        transition: opacity 0.3s;
        font-family: "Smooch Sans", serif;
        font-size: larger;
        margin-top: 15px;
    }

    button:hover {
        opacity: 0.8;
    }

    button:active {
        opacity: 0.4;
    }

    .container {
        position: fixed;
        left: 50%;
        bottom: 50%;
        transform: translate(-50%, 50%);
        font-family: "Smooch Sans", serif;
        text-align: center;
        border-style: solid;
        border-radius: 15px;
        border-width: 2px;
        background-color: light-dark(white, black);
        border-color: light-dark(black, white);
        height: 35%;
        width: 23%;
        backdrop-filter: blur(3px);
    }

    #backBtn {
        width: 40px;
        margin-left: 5px;
        margin-right: 5px;
        background-color: white;
        border: 1px solid black;
    }

    #title {
        color: light-dark(black, white);
        display: inline;
    }

    input {
        border-radius: 20px;
        border-width: 2px;
        border-color: light-dark(black, white);
        border-style: solid;
        height: 35px;
        width: 220px;
        font-family: "Smooch Sans", serif;
        font-size: larger;
        background: transparent;
        color: light-dark(black, white);
        padding-left: 15px;
        margin-top: 15px;
    }

    html {
        background-image: url('naranjafondo.jpg');
        background-size: 1100px;
        background-position: top;
    }
</style>
